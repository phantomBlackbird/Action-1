<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mini World Explorer - Custom Ground Model</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000; transition: opacity 0.5s;
            color: white; text-align: center;
        }
        
        .loading-content {
            background: rgba(0,0,0,0.5); padding: 40px;
            border-radius: 20px; backdrop-filter: blur(10px);
        }
        
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-radius: 50%; border-top-color: #4a9eff;
            animation: spin 1s ease-in-out infinite;
            margin: 20px auto;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #loading-status {
            font-size: 18px; margin-top: 20px;
            padding: 10px 20px; background: rgba(74, 158, 255, 0.3);
            border-radius: 30px;
        }
        
        #touch-controls {
            position: fixed; bottom: 30px; left: 0; right: 0;
            display: flex; justify-content: space-between; padding: 20px;
            pointer-events: none; z-index: 1000;
        }
        
        .joystick-area {
            pointer-events: auto; width: 120px; height: 120px;
            background: rgba(30, 30, 50, 0.8); border-radius: 60px;
            backdrop-filter: blur(5px); border: 2px solid #4a9eff;
            display: flex; justify-content: center; align-items: center;
            touch-action: none;
            box-shadow: 0 0 20px rgba(74, 158, 255, 0.3);
        }
        
        .joystick {
            width: 50px; height: 50px; background: white;
            border-radius: 25px; border: 2px solid #4a9eff;
            transition: transform 0.05s;
        }
        
        .action-buttons {
            display: flex; gap: 15px; pointer-events: auto;
            flex-wrap: wrap; justify-content: flex-end;
            max-width: 300px;
        }
        
        .action-btn {
            width: 80px; height: 80px; border-radius: 40px;
            background: rgba(30, 30, 50, 0.8); border: 3px solid #4a9eff;
            color: white; font-size: 14px; font-weight: bold;
            backdrop-filter: blur(5px); cursor: pointer;
            transition: all 0.1s;
            box-shadow: 0 0 15px rgba(74, 158, 255, 0.3);
            touch-action: manipulation;
            user-select: none;
        }
        
        .action-btn:active { transform: scale(0.95); background: #4a9eff; }
        .action-btn.holding { 
            transform: scale(0.9); 
            background: #ffaa00;
            box-shadow: 0 0 30px #ffaa00;
        }
        
        #jump-btn { border-color: #ffaa00; }
        #shoot-btn { border-color: #ff4757; }
        #grenade-btn { border-color: #9f7aea; }
        
        #hud {
            position: fixed; top: 20px; left: 20px; color: white;
            background: rgba(30, 30, 50, 0.8); padding: 15px 25px;
            border-radius: 10px; backdrop-filter: blur(5px);
            border: 2px solid #4a9eff; z-index: 1000;
        }
        
        #hud .title { font-size: 24px; font-weight: bold; color: #4a9eff; }
        #hud .size { color: #88ff88; }
        
        #anim-status {
            position: fixed; bottom: 200px; left: 50%;
            transform: translateX(-50%);
            color: #4a9eff; font-size: 24px; font-weight: bold;
            background: rgba(30, 30, 50, 0.9); padding: 10px 30px;
            border-radius: 40px; border: 2px solid #4a9eff;
            z-index: 1000; backdrop-filter: blur(5px);
            box-shadow: 0 0 30px rgba(74, 158, 255, 0.5);
            min-width: 200px;
            text-align: center;
        }
        
        #controls-hint {
            position: fixed; bottom: 120px; left: 50%;
            transform: translateX(-50%);
            color: white; background: rgba(30, 30, 50, 0.8);
            padding: 10px 25px; border-radius: 30px;
            border: 1px solid #4a9eff; z-index: 1000;
        }
        
        #rapid-indicator {
            position: fixed; bottom: 300px; right: 20px;
            color: #ffaa00; background: rgba(0,0,0,0.7);
            padding: 5px 10px; border-radius: 20px;
            font-size: 12px; border: 1px solid #ffaa00;
            display: none;
        }
        
        #debug-info {
            position: fixed; top: 80px; right: 20px;
            color: #4a9eff; background: rgba(30, 30, 50, 0.8);
            padding: 8px 15px; border-radius: 20px;
            font-size: 12px; border: 1px solid #4a9eff;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="loading-content">
            <h1>üåç MINI WORLD EXPLORER</h1>
            <h3>Using Custom Ground Model</h3>
            <div class="spinner"></div>
            <div id="loading-status">Loading Player.glb...</div>
        </div>
    </div>

    <div id="hud">
        <div class="title">‚öîÔ∏è MINI EXPLORER</div>
        <div class="size">Size: <span style="color: #88ff88;">3x (0.009 scale)</span></div>
        <div>X: <span id="pos-x">0.0</span> Z: <span id="pos-z">0.0</span></div>
    </div>
    
    <div id="anim-status">IDLE</div>
    <div id="controls-hint">üëÜ Joystick to move | Hold buttons for actions</div>
    <div id="rapid-indicator">üî• RAPID FIRE</div>
    <div id="debug-info">Ground: Ground.glb</div>

    <div id="touch-controls">
        <div class="joystick-area" id="move-joystick">
            <div class="joystick" id="joystick-handle"></div>
        </div>
        
        <div class="action-buttons">
            <button class="action-btn" id="jump-btn">ü¶ò JUMP</button>
            <button class="action-btn" id="shoot-btn">üî´ SHOOT</button>
            <button class="action-btn" id="grenade-btn">üí£ GRENADE</button>
        </div>
    </div>
    
    <a-scene background="color: #87CEEB" shadow="type: pcfsoft" vr-mode-ui="enabled: false" renderer="antialias: true">
        <a-assets>
            <!-- Your models from GitHub -->
            <a-asset-item id="player-model" src="Player.glb"></a-asset-item>
            <a-asset-item id="gun-model" src="Mpsd.glb"></a-asset-item>
            <a-asset-item id="ground-model" src="Ground.glb"></a-asset-item>
            <a-asset-item id="subrural-model" src="Subrural.glb"></a-asset-item>
        </a-assets>

        <!-- Ground Model - Your custom ground -->
        <a-gltf-model 
            id="ground" 
            src="#ground-model"
            position="0 0 0"
            scale="1 1 1"
            receive-shadow
            static-body>
        </a-gltf-model>

        <!-- Player Character - 3x Larger -->
        <a-entity id="player-position" position="0 0.18 0">  <!-- Height adjusted for ground -->
            <!-- Player rotation container -->
            <a-entity id="player-rotation" position="0 0 0">
                <a-gltf-model 
                    id="player-model-instance" 
                    src="#player-model"
                    scale="0.009 0.009 0.009"
                    animation-mixer="clip: idle; loop: repeat; crossFadeDuration: 0.1"
                    shadow="cast: true; receive: true">
                </a-gltf-model>
                
                <!-- Gun attached to player -->
                <a-entity id="gun" position="0.9 0.9 0.9" rotation="0 90 0" scale="0.0075 0.0075 0.0075">
                    <a-gltf-model 
                        id="gun-model-instance" 
                        src="#gun-model"
                        shadow="cast: true; receive: true">
                    </a-gltf-model>
                </a-entity>
            </a-entity>
        </a-entity>

        <!-- Camera Rig - Third Person View -->
        <a-entity id="camera-rig" position="0 1.5 5.0">
            <a-camera id="camera" wasd-controls="enabled: false" look-controls="enabled: true"></a-camera>
        </a-entity>
        
        <!-- Lighting -->
        <a-light type="ambient" intensity="0.6"></a-light>
        <a-light type="directional" position="2 10 3" intensity="1.5" castshadow="true" shadow-mapSize-width="2048" shadow-mapSize-height="2048"></a-light>
        <a-light type="point" position="0 5 5" intensity="1.0" color="#FFFFFF"></a-light>
        
        <!-- Subrural environment model (optional - comment out if not needed) -->
        <!-- <a-gltf-model 
            id="environment" 
            src="#subrural-model"
            position="0 0 0"
            scale="1 1 1"
            shadow="receive: true">
        </a-gltf-model> -->
        
        <!-- Simple objects for scale reference (placed on ground) -->
        <a-box position="5 0.5 5" width="1" height="1" depth="1" color="#FF6B6B" shadow></a-box>
        <a-box position="-5 0.5 -5" width="1" height="1" depth="1" color="#4ECDC4" shadow></a-box>
        <a-cylinder position="3 0.5 -3" radius="0.5" height="1" color="#FFE66D" shadow></a-cylinder>
        <a-sphere position="-3 0.5 3" radius="0.5" color="#9f7aea" shadow></a-sphere>
    </a-scene>
    
    <script>
        (function() {
            console.log('Starting Mini World Explorer with Custom Ground Model...');
            
            // ===== ANIMATION MAPPING =====
            const ANIMATIONS = {
                IDLE: 'idle',
                RUN_FORWARD: 'run-forward',
                RUN_BACKWARDS: 'run-backwards',
                RUN_LEFT: 'run-left',
                RUN_RIGHT: 'run-right',
                WALK_FORWARD: 'walk-forward',
                WALK_BACKWARDS: 'walk-backwards',
                WALK_LEFT: 'walk-left',
                WALK_RIGHT: 'walk-right',
                JUMP: 'jump',
                SHOOT_RIFLE: 'shoot-rifle',
                THROW_GRENADE: 'throw-grenade'
            };
            
            // Blacklist - animations we NEVER want to play
            const BLACKLIST_ANIMATIONS = ['t-pose'];
            
            // ===== DOM Elements =====
            const loadingScreen = document.getElementById('loading-screen');
            const loadingStatus = document.getElementById('loading-status');
            const animStatus = document.getElementById('anim-status');
            const rapidIndicator = document.getElementById('rapid-indicator');
            const debugInfo = document.getElementById('debug-info');
            const posX = document.getElementById('pos-x');
            const posZ = document.getElementById('pos-z');
            
            // ===== Button Elements =====
            const jumpBtn = document.getElementById('jump-btn');
            const shootBtn = document.getElementById('shoot-btn');
            const grenadeBtn = document.getElementById('grenade-btn');
            
            // ===== State =====
            let joystickActive = false;
            let joystickX = 0;
            let joystickY = 0;
            
            // Button hold states
            let jumpActive = false;
            let shootingActive = false;
            let grenadeActive = false;
            
            // Intervals
            let jumpInterval = null;
            let shootInterval = null;
            let grenadeInterval = null;
            
            // Movement speed - increased for larger player
            const WALK_SPEED = 0.06;
            const RUN_SPEED = 0.105;
            
            // Rapid fire settings
            const RAPID_FIRE_DELAY = 100;
            const JUMP_DELAY = 400;
            const GRENADE_DELAY = 300;
            
            // Jump settings
            const JUMP_HEIGHT = 0.24;
            const GROUND_LEVEL = 0.18;  // Adjust based on ground model height
            
            // ===== A-Frame Elements =====
            const scene = document.querySelector('a-scene');
            const playerPosition = document.getElementById('player-position');
            const playerRotation = document.getElementById('player-rotation');
            const cameraRig = document.getElementById('camera-rig');
            const camera = document.getElementById('camera');
            const playerModel = document.getElementById('player-model-instance');
            const gun = document.getElementById('gun');
            const gunModel = document.getElementById('gun-model-instance');
            const groundModel = document.getElementById('ground');
            
            // ===== Safe Animation Function =====
            function setSafeAnimation(animName, loopType = 'repeat') {
                if (!playerModel) return;
                
                // NEVER play blacklisted animations
                if (BLACKLIST_ANIMATIONS.includes(animName)) {
                    console.warn('Blocked blacklisted animation:', animName);
                    animName = ANIMATIONS.IDLE;
                }
                
                // Update UI
                let displayName = animName.toUpperCase();
                if (animName === ANIMATIONS.IDLE) displayName = 'IDLE';
                else if (animName.includes('run')) displayName = 'üèÉ RUNNING';
                else if (animName.includes('walk')) displayName = 'üö∂ WALKING';
                else if (animName === ANIMATIONS.SHOOT_RIFLE) displayName = 'üî´ SHOOTING';
                else if (animName === ANIMATIONS.JUMP) displayName = 'ü¶ò JUMPING';
                else if (animName === ANIMATIONS.THROW_GRENADE) displayName = 'üí£ GRENADE';
                
                animStatus.textContent = displayName;
                
                // Set the animation
                try {
                    playerModel.setAttribute('animation-mixer', {
                        clip: animName,
                        loop: loopType,
                        crossFadeDuration: 0.1,
                        timeScale: 1.0
                    });
                } catch (e) {
                    // Fallback to idle
                    playerModel.setAttribute('animation-mixer', {
                        clip: ANIMATIONS.IDLE,
                        loop: 'repeat',
                        crossFadeDuration: 0.1
                    });
                }
            }
            
            // ===== Jump Function =====
            function performJump() {
                if (!playerPosition) return;
                
                // Play jump animation (one-shot)
                setSafeAnimation(ANIMATIONS.JUMP, 'once');
                
                // Jump physics
                const startY = playerPosition.getAttribute('position').y;
                const jumpStart = Date.now();
                const JUMP_DURATION = 500;
                
                function animateJump() {
                    const elapsed = Date.now() - jumpStart;
                    const progress = Math.min(elapsed / JUMP_DURATION, 1);
                    
                    if (progress >= 1) {
                        const pos = playerPosition.getAttribute('position');
                        pos.y = GROUND_LEVEL;
                        playerPosition.setAttribute('position', pos);
                        return;
                    }
                    
                    const jumpProgress = Math.sin(progress * Math.PI);
                    const pos = playerPosition.getAttribute('position');
                    pos.y = startY + (JUMP_HEIGHT * jumpProgress);
                    playerPosition.setAttribute('position', pos);
                    
                    requestAnimationFrame(animateJump);
                }
                
                animateJump();
            }
            
            function startJumping() {
                if (jumpActive) return;
                
                jumpActive = true;
                jumpBtn.classList.add('holding');
                
                // Perform first jump immediately
                performJump();
                
                // Set up interval for continuous jumping
                jumpInterval = setInterval(() => {
                    if (jumpActive) {
                        performJump();
                    }
                }, JUMP_DELAY);
            }
            
            function stopJumping() {
                jumpActive = false;
                jumpBtn.classList.remove('holding');
                
                if (jumpInterval) {
                    clearInterval(jumpInterval);
                    jumpInterval = null;
                }
                
                // Return to appropriate animation
                if (shootingActive) {
                    setSafeAnimation(ANIMATIONS.SHOOT_RIFLE, 'repeat');
                } else if (grenadeActive) {
                    setSafeAnimation(ANIMATIONS.THROW_GRENADE, 'repeat');
                } else if (joystickActive) {
                    updateMovementAnimation();
                } else {
                    setSafeAnimation(ANIMATIONS.IDLE, 'repeat');
                }
            }
            
            // ===== Shoot Functions =====
            function startShooting() {
                if (shootingActive) return;
                
                shootingActive = true;
                shootBtn.classList.add('holding');
                
                // Show rapid indicator
                rapidIndicator.style.display = 'block';
                
                // Play shoot animation continuously
                setSafeAnimation(ANIMATIONS.SHOOT_RIFLE, 'repeat');
                
                // Start muzzle flash effect
                if (gunModel) {
                    shootInterval = setInterval(() => {
                        if (!shootingActive) return;
                        
                        gunModel.setAttribute('material', 'emissive', '#FF5500');
                        gunModel.setAttribute('material', 'emissiveIntensity', '2.0');
                        
                        setTimeout(() => {
                            if (shootingActive) {
                                gunModel.setAttribute('material', 'emissive', '#000000');
                                gunModel.setAttribute('material', 'emissiveIntensity', '0');
                            }
                        }, 50);
                    }, RAPID_FIRE_DELAY);
                }
            }
            
            function stopShooting() {
                shootingActive = false;
                shootBtn.classList.remove('holding');
                rapidIndicator.style.display = 'none';
                
                if (shootInterval) {
                    clearInterval(shootInterval);
                    shootInterval = null;
                }
                
                // Reset gun material
                if (gunModel) {
                    gunModel.setAttribute('material', 'emissive', '#000000');
                    gunModel.setAttribute('material', 'emissiveIntensity', '0');
                }
                
                // Return to appropriate animation
                if (jumpActive) {
                    setSafeAnimation(ANIMATIONS.JUMP, 'repeat');
                } else if (grenadeActive) {
                    setSafeAnimation(ANIMATIONS.THROW_GRENADE, 'repeat');
                } else if (joystickActive) {
                    updateMovementAnimation();
                } else {
                    setSafeAnimation(ANIMATIONS.IDLE, 'repeat');
                }
            }
            
            // ===== Grenade Functions =====
            function startGrenade() {
                if (grenadeActive) return;
                
                grenadeActive = true;
                grenadeBtn.classList.add('holding');
                
                // Play grenade animation continuously
                setSafeAnimation(ANIMATIONS.THROW_GRENADE, 'repeat');
                
                // Visual effect for grenade holding
                grenadeInterval = setInterval(() => {
                    if (!grenadeActive) return;
                    
                    gunModel?.setAttribute('material', 'emissive', '#9f7aea');
                    gunModel?.setAttribute('material', 'emissiveIntensity', '1.0');
                    
                    setTimeout(() => {
                        if (grenadeActive) {
                            gunModel?.setAttribute('material', 'emissive', '#000000');
                            gunModel?.setAttribute('material', 'emissiveIntensity', '0');
                        }
                    }, 50);
                }, GRENADE_DELAY);
            }
            
            function stopGrenade() {
                grenadeActive = false;
                grenadeBtn.classList.remove('holding');
                
                if (grenadeInterval) {
                    clearInterval(grenadeInterval);
                    grenadeInterval = null;
                }
                
                // Reset gun material
                if (gunModel) {
                    gunModel.setAttribute('material', 'emissive', '#000000');
                    gunModel.setAttribute('material', 'emissiveIntensity', '0');
                }
                
                // Return to appropriate animation
                if (jumpActive) {
                    setSafeAnimation(ANIMATIONS.JUMP, 'repeat');
                } else if (shootingActive) {
                    setSafeAnimation(ANIMATIONS.SHOOT_RIFLE, 'repeat');
                } else if (joystickActive) {
                    updateMovementAnimation();
                } else {
                    setSafeAnimation(ANIMATIONS.IDLE, 'repeat');
                }
            }
            
            // ===== Movement Animation =====
            function updateMovementAnimation() {
                if (jumpActive || shootingActive || grenadeActive) return;
                
                if (!joystickActive) {
                    setSafeAnimation(ANIMATIONS.IDLE, 'repeat');
                    return;
                }
                
                const magnitude = Math.sqrt(joystickX * joystickX + joystickY * joystickY);
                
                if (magnitude < 0.1) {
                    setSafeAnimation(ANIMATIONS.IDLE, 'repeat');
                    return;
                }
                
                const isRunning = magnitude > 0.7;
                
                // Determine direction based on joystick input
                if (Math.abs(joystickX) > Math.abs(joystickY)) {
                    // Strafe
                    if (joystickX > 0) {
                        setSafeAnimation(isRunning ? ANIMATIONS.RUN_RIGHT : ANIMATIONS.WALK_RIGHT, 'repeat');
                    } else {
                        setSafeAnimation(isRunning ? ANIMATIONS.RUN_LEFT : ANIMATIONS.WALK_LEFT, 'repeat');
                    }
                } else {
                    // Forward/backward
                    if (joystickY > 0) {
                        setSafeAnimation(isRunning ? ANIMATIONS.RUN_FORWARD : ANIMATIONS.WALK_FORWARD, 'repeat');
                    } else {
                        setSafeAnimation(isRunning ? ANIMATIONS.RUN_BACKWARDS : ANIMATIONS.WALK_BACKWARDS, 'repeat');
                    }
                }
            }
            
            // ===== Joystick Setup =====
            const moveJoystick = document.getElementById('move-joystick');
            const joystickHandle = document.getElementById('joystick-handle');
            
            moveJoystick.addEventListener('touchstart', (e) => {
                e.preventDefault();
                joystickActive = true;
                updateJoystick(e.touches[0]);
            });
            
            moveJoystick.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (joystickActive) updateJoystick(e.touches[0]);
            });
            
            moveJoystick.addEventListener('touchend', (e) => {
                e.preventDefault();
                joystickActive = false;
                joystickX = 0;
                joystickY = 0;
                joystickHandle.style.transform = 'translate(0px, 0px)';
                
                // Only change animation if not doing actions
                if (!jumpActive && !shootingActive && !grenadeActive) {
                    setSafeAnimation(ANIMATIONS.IDLE, 'repeat');
                }
            });
            
            function updateJoystick(touch) {
                const rect = moveJoystick.getBoundingClientRect();
                const centerX = rect.left + rect.width/2;
                const centerY = rect.top + rect.height/2;
                
                let deltaX = touch.clientX - centerX;
                let deltaY = touch.clientY - centerY;
                
                const maxDistance = 40;
                const distance = Math.sqrt(deltaX*deltaX + deltaY*deltaY);
                
                if (distance > maxDistance) {
                    deltaX = (deltaX/distance) * maxDistance;
                    deltaY = (deltaY/distance) * maxDistance;
                }
                
                joystickHandle.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
                joystickX = deltaX / maxDistance;
                joystickY = deltaY / maxDistance;
                
                // Update movement animation if not doing actions
                if (!jumpActive && !shootingActive && !grenadeActive) {
                    updateMovementAnimation();
                }
            }
            
            // ===== Button Setup =====
            jumpBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startJumping();
            });
            
            jumpBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                stopJumping();
            });
            
            jumpBtn.addEventListener('touchcancel', (e) => {
                e.preventDefault();
                stopJumping();
            });
            
            shootBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startShooting();
            });
            
            shootBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                stopShooting();
            });
            
            shootBtn.addEventListener('touchcancel', (e) => {
                e.preventDefault();
                stopShooting();
            });
            
            grenadeBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startGrenade();
            });
            
            grenadeBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                stopGrenade();
            });
            
            grenadeBtn.addEventListener('touchcancel', (e) => {
                e.preventDefault();
                stopGrenade();
            });
            
            // Mouse fallback for testing
            jumpBtn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                startJumping();
            });
            
            jumpBtn.addEventListener('mouseup', (e) => {
                e.preventDefault();
                stopJumping();
            });
            
            jumpBtn.addEventListener('mouseleave', (e) => {
                stopJumping();
            });
            
            shootBtn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                startShooting();
            });
            
            shootBtn.addEventListener('mouseup', (e) => {
                e.preventDefault();
                stopShooting();
            });
            
            shootBtn.addEventListener('mouseleave', (e) => {
                stopShooting();
            });
            
            grenadeBtn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                startGrenade();
            });
            
            grenadeBtn.addEventListener('mouseup', (e) => {
                e.preventDefault();
                stopGrenade();
            });
            
            grenadeBtn.addEventListener('mouseleave', (e) => {
                stopGrenade();
            });
            
            // Keyboard fallback
            window.addEventListener('keydown', (e) => {
                switch(e.key) {
                    case ' ': 
                        e.preventDefault(); 
                        if (!jumpActive) startJumping();
                        break;
                    case 'f': 
                    case 'F': 
                        e.preventDefault(); 
                        if (!shootingActive) startShooting();
                        break;
                    case 'g':
                    case 'G':
                        e.preventDefault();
                        if (!grenadeActive) startGrenade();
                        break;
                }
            });
            
            window.addEventListener('keyup', (e) => {
                switch(e.key) {
                    case ' ':
                        stopJumping();
                        break;
                    case 'f':
                    case 'F':
                        stopShooting();
                        break;
                    case 'g':
                    case 'G':
                        stopGrenade();
                        break;
                }
            });
            
            // ===== MOVEMENT SYSTEM =====
            function movePlayer() {
                if (!joystickActive || !playerPosition || !camera) return;
                
                const playerPos = playerPosition.getAttribute('position');
                const cameraRot = camera.getAttribute('rotation');
                
                const radY = THREE.MathUtils.degToRad(cameraRot.y);
                const magnitude = Math.sqrt(joystickX * joystickX + joystickY * joystickY);
                const speed = magnitude > 0.7 ? RUN_SPEED : WALK_SPEED;
                
                // Calculate movement relative to camera
                let moveX = 0;
                let moveZ = 0;
                
                // Forward/back (joystick Y)
                if (joystickY !== 0) {
                    moveX += Math.sin(radY) * joystickY * speed;
                    moveZ += Math.cos(radY) * joystickY * speed;
                }
                
                // Strafe (joystick X)
                if (joystickX !== 0) {
                    moveX += Math.sin(radY + Math.PI/2) * joystickX * speed;
                    moveZ += Math.cos(radY + Math.PI/2) * joystickX * speed;
                }
                
                // Apply movement
                playerPos.x += moveX;
                playerPos.z += moveZ;
                
                // Keep in bounds (adjust based on ground size)
                playerPos.x = Math.max(-45, Math.min(45, playerPos.x));
                playerPos.z = Math.max(-45, Math.min(45, playerPos.z));
                
                playerPosition.setAttribute('position', playerPos);
                
                // Rotate player to face movement direction
                if (moveX !== 0 || moveZ !== 0) {
                    const targetAngle = Math.atan2(moveX, moveZ);
                    const targetDeg = THREE.MathUtils.radToDeg(targetAngle);
                    
                    // Apply rotation to player rotation container
                    playerRotation.setAttribute('rotation', {
                        x: 0,
                        y: targetDeg,
                        z: 0
                    });
                }
                
                // Update HUD
                if (posX) posX.textContent = Math.round(playerPos.x * 10) / 10;
                if (posZ) posZ.textContent = Math.round(playerPos.z * 10) / 10;
                
                // Update debug info
                debugInfo.innerHTML = `Ground: Ground.glb<br>Y: ${playerPos.y.toFixed(2)}`;
            }
            
            // ===== CAMERA FOLLOW (Third Person) =====
            function updateCamera() {
                if (!playerPosition || !cameraRig) return;
                
                const playerPos = playerPosition.getAttribute('position');
                
                // Position camera rig at player position + offset
                cameraRig.setAttribute('position', {
                    x: playerPos.x,
                    y: playerPos.y + 1.5,
                    z: playerPos.z + 5.0
                });
                
                // Make camera look at player
                const cameraObj = camera?.object3D;
                const playerObj = playerRotation?.object3D;
                
                if (cameraObj && playerObj) {
                    cameraObj.lookAt(playerObj.position);
                }
            }
            
            // ===== Model Loading =====
            let modelsLoaded = 0;
            const totalModels = 3; // Player, Gun, Ground
            
            function updateLoadingProgress() {
                loadingStatus.textContent = `Loading models... (${modelsLoaded}/${totalModels})`;
            }
            
            if (playerModel) {
                playerModel.addEventListener('model-loaded', () => {
                    console.log('‚úÖ Player model loaded');
                    modelsLoaded++;
                    updateLoadingProgress();
                    
                    // Make player visible
                    if (playerRotation) {
                        playerRotation.setAttribute('rotation', {x: 0, y: 0, z: 0});
                    }
                    
                    // Blacklist any t-pose animations
                    setTimeout(() => {
                        try {
                            const mixer = playerModel.components['animation-mixer'];
                            if (mixer && mixer.clips) {
                                mixer.clips.forEach(clip => {
                                    if (clip.name.toLowerCase().includes('pose')) {
                                        if (!BLACKLIST_ANIMATIONS.includes(clip.name)) {
                                            BLACKLIST_ANIMATIONS.push(clip.name);
                                            console.log('Blacklisted:', clip.name);
                                        }
                                    }
                                });
                            }
                        } catch(e) {}
                    }, 1000);
                    
                    checkAllLoaded();
                });
                
                playerModel.addEventListener('error', (e) => {
                    console.error('Player model error:', e);
                    modelsLoaded++;
                    updateLoadingProgress();
                    checkAllLoaded();
                });
            }
            
            if (gunModel) {
                gunModel.addEventListener('model-loaded', () => {
                    console.log('‚úÖ Gun model loaded');
                    modelsLoaded++;
                    updateLoadingProgress();
                    gunModel.setAttribute('visible', 'true');
                    checkAllLoaded();
                });
                
                gunModel.addEventListener('error', (e) => {
                    console.error('Gun model error:', e);
                    modelsLoaded++;
                    updateLoadingProgress();
                    
                    // Create simple gun as fallback
                    const simpleGun = document.createElement('a-box');
                    simpleGun.setAttribute('width', '0.2');
                    simpleGun.setAttribute('height', '0.1');
                    simpleGun.setAttribute('depth', '0.4');
                    simpleGun.setAttribute('color', '#333');
                    simpleGun.setAttribute('position', '0 0 0');
                    gun.appendChild(simpleGun);
                    
                    checkAllLoaded();
                });
            }
            
            if (groundModel) {
                groundModel.addEventListener('model-loaded', () => {
                    console.log('‚úÖ Ground model loaded');
                    modelsLoaded++;
                    updateLoadingProgress();
                    
                    // Adjust ground position/size if needed
                    // You might need to scale or position the ground based on its actual dimensions
                    groundModel.setAttribute('shadow', 'receive: true');
                    
                    checkAllLoaded();
                });
                
                groundModel.addEventListener('error', (e) => {
                    console.error('Ground model error:', e);
                    modelsLoaded++;
                    updateLoadingProgress();
                    
                    // Create fallback ground plane if model fails
                    const fallbackGround = document.createElement('a-plane');
                    fallbackGround.setAttribute('rotation', '-90 0 0');
                    fallbackGround.setAttribute('width', '200');
                    fallbackGround.setAttribute('height', '200');
                    fallbackGround.setAttribute('color', '#3a6ea5');
                    fallbackGround.setAttribute('receive-shadow', 'true');
                    scene.appendChild(fallbackGround);
                    
                    checkAllLoaded();
                });
            }
            
            function checkAllLoaded() {
                if (modelsLoaded >= totalModels) {
                    loadingStatus.textContent = '‚ú® World ready!';
                    
                    setTimeout(() => {
                        loadingScreen.style.opacity = '0';
                        setTimeout(() => {
                            loadingScreen.style.display = 'none';
                        }, 500);
                    }, 1000);
                    
                    setSafeAnimation(ANIMATIONS.IDLE, 'repeat');
                }
            }
            
            // ===== Game Loop =====
            function gameLoop() {
                movePlayer();
                updateCamera();
                requestAnimationFrame(gameLoop);
            }
            
            scene.addEventListener('loaded', () => {
                console.log('Scene loaded');
                gameLoop();
            });
        })();
    </script>
</body>
</html>
