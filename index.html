<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mini Player World - Full Animation System</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        /* Mobile touch controls styling */
        #touch-controls {
            position: fixed;
            bottom: 30px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 20px;
            pointer-events: none;
            z-index: 1000;
        }
        
        .joystick-area {
            pointer-events: auto;
            width: 120px;
            height: 120px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 60px;
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
        }
        
        .joystick {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 25px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            pointer-events: auto;
            flex-wrap: wrap;
            justify-content: flex-end;
            max-width: 300px;
        }
        
        .action-btn {
            width: 70px;
            height: 70px;
            border-radius: 35px;
            background: rgba(0, 150, 255, 0.7);
            border: 3px solid rgba(255, 255, 255, 0.8);
            color: white;
            font-size: 14px;
            font-weight: bold;
            backdrop-filter: blur(5px);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            touch-action: manipulation;
            cursor: pointer;
        }
        
        .action-btn:active {
            transform: scale(0.95);
            background: rgba(0, 100, 200, 0.9);
        }
        
        #jump-btn {
            background: rgba(255, 100, 0, 0.7);
        }
        
        #jump-btn:active {
            background: rgba(200, 80, 0, 0.9);
        }
        
        #shoot-btn {
            background: rgba(255, 50, 50, 0.7);
        }
        
        #grenade-btn {
            background: rgba(150, 50, 150, 0.7);
        }
        
        /* Animation Controls Panel */
        #animation-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            color: white;
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            z-index: 1000;
            max-width: 250px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        #animation-panel h3 {
            margin: 0 0 10px 0;
            text-align: center;
            color: #ffaa00;
        }
        
        .animation-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .anim-btn {
            background: rgba(50, 50, 50, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            text-align: left;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .anim-btn:hover {
            background: rgba(100, 100, 100, 0.8);
        }
        
        .anim-btn.active {
            background: #ffaa00;
            color: black;
            font-weight: bold;
        }
        
        .playback-control {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .playback-control input {
            width: 100%;
        }
        
        /* UI Elements */
        #hud {
            position: fixed;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 18px;
            text-shadow: 2px 2px 2px black;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 10px;
            backdrop-filter: blur(5px);
        }
        
        #debug-info {
            position: fixed;
            top: 20px;
            right: 290px;
            color: white;
            font-size: 14px;
            background: rgba(0,0,0,0.5);
            padding: 8px 15px;
            border-radius: 20px;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        /* Controls hint */
        #controls-hint {
            position: fixed;
            bottom: 180px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 14px;
            background: rgba(0,0,0,0.5);
            padding: 8px 20px;
            border-radius: 20px;
            z-index: 1000;
            backdrop-filter: blur(5px);
            text-align: center;
            white-space: nowrap;
        }
        
        /* Current animation display */
        #current-animation {
            position: fixed;
            top: 100px;
            left: 20px;
            color: #ffaa00;
            font-size: 16px;
            background: rgba(0,0,0,0.5);
            padding: 5px 15px;
            border-radius: 20px;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body>
    <!-- HUD Display -->
    <div id="hud">
        <div>üåà Mini World Explorer</div>
        <div>Position: <span id="pos-x">0</span>, <span id="pos-z">0</span></div>
    </div>
    
    <!-- Current Animation Display -->
    <div id="current-animation">Animation: idle</div>
    
    <!-- Debug Info -->
    <div id="debug-info">Player Size: 10x smaller than original</div>
    
    <!-- Animation Panel -->
    <div id="animation-panel">
        <h3>üéÆ Animation Controls</h3>
        <div class="playback-control">
            <label>Playback Speed: <span id="speed-value">1.0</span></label>
            <input type="range" id="playback-speed" min="0" max="2" step="0.1" value="1">
        </div>
        <div class="animation-list" id="animation-list">
            <button class="anim-btn active" data-anim="idle">1. üßç Idle</button>
            <button class="anim-btn" data-anim="t-pose">2. ‚≠ê T-Pose</button>
            <button class="anim-btn" data-anim="walk-forward">3. üö∂ Walk Forward</button>
            <button class="anim-btn" data-anim="walk-backwards">4. üö∂ Walk Backwards</button>
            <button class="anim-btn" data-anim="walk-left">5. üö∂ Walk Left</button>
            <button class="anim-btn" data-anim="walk-right">6. üö∂ Walk Right</button>
            <button class="anim-btn" data-anim="run-forward">7. üèÉ Run Forward</button>
            <button class="anim-btn" data-anim="run-backwards">8. üèÉ Run Backwards</button>
            <button class="anim-btn" data-anim="run-left">9. üèÉ Run Left</button>
            <button class="anim-btn" data-anim="run-right">10. üèÉ Run Right</button>
            <button class="anim-btn" data-anim="jump">11. ü¶ò Jump</button>
            <button class="anim-btn" data-anim="shoot-pistol">12. üî´ Shoot Pistol</button>
            <button class="anim-btn" data-anim="shoot-rifle">13. üî´ Shoot Rifle</button>
            <button class="anim-btn" data-anim="throw-grenade">14. üí£ Throw Grenade</button>
            <button class="anim-btn" data-anim="reloading">15. üîÑ Reloading</button>
            <button class="anim-btn" data-anim="hit-reaction-1">16. üí• Hit Reaction 1</button>
            <button class="anim-btn" data-anim="hit-reaction-2">17. üí• Hit Reaction 2</button>
        </div>
    </div>
    
    <!-- Controls Hint -->
    <div id="controls-hint">‚¨ÜÔ∏è‚¨áÔ∏è‚¨ÖÔ∏è‚û°Ô∏è Joystick | JUMP | SHOOT | GRENADE</div>
    
    <!-- Mobile Touch Controls -->
    <div id="touch-controls">
        <div class="joystick-area" id="move-joystick">
            <div class="joystick" id="joystick-handle"></div>
        </div>
        
        <div class="action-buttons">
            <button class="action-btn" id="jump-btn">JUMP</button>
            <button class="action-btn" id="shoot-btn">SHOOT</button>
            <button class="action-btn" id="grenade-btn">GRENADE</button>
        </div>
    </div>
    
    <!-- A-Frame Scene -->
    <a-scene background="color: #87CEEB" shadow="type: pcfsoft" physics="gravity: -9.8;">
        <!-- Assets -->
        <a-assets>
            <!-- Tiny Player Model - Replace with your actual model URL or use a fallback -->
            <a-asset-item id="player-model" src="Player.glb"></a-asset-item>
            
            <!-- Environment Textures -->
            <img id="ground-texture" src="https://cdn.aframe.io/aframe-brand/examples/ground.jpg" crossorigin="anonymous">
        </a-assets>
        
        <!-- Third Person Camera Rig -->
        <a-entity id="camera-rig" position="0 1 0">
            <!-- Tiny Player with Animation Mixer -->
            <a-entity id="player" position="0 0 0">
                <a-gltf-model id="player-model-instance" src="#player-model" scale="0.05 0.05 0.05" position="0 0 0" animation-mixer="clip: idle; loop: repeat; timeScale: 1;"></a-gltf-model>
                
                <!-- Simple player shadow -->
                <a-circle position="0 -0.1 0" rotation="-90 0 0" radius="0.15" color="#333" material="opacity: 0.3; transparent: true"></a-circle>
            </a-entity>
            
            <!-- Camera positioned behind the tiny player -->
            <a-camera id="camera" wasd-controls="enabled: false" look-controls="enabled: true" position="0 0.8 2.0" rotation="0 0 0"></a-camera>
        </a-entity>
        
        <!-- Enhanced Lighting -->
        <a-light type="ambient" color="#fff" intensity="0.6"></a-light>
        <a-light type="directional" position="2 5 3" intensity="1.2" castshadow="true" shadow-mapSize-width="2048" shadow-mapSize-height="2048"></a-light>
        <a-light type="point" position="0 3 0" intensity="0.5" color="#FFEECC"></a-light>
        
        <!-- Massive Ground for tiny player to explore -->
        <a-plane id="ground" rotation="-90 0 0" width="200" height="200" material="src: #ground-texture; repeat: 40 40; roughness: 0.8; metalness: 0.1" receive-shadow></a-plane>
        
        <!-- Decorative grid for scale reference -->
        <a-grid position="0 0.01 0" width="200" height="200" cell-size="1" material="color: #888; opacity: 0.15"></a-grid>
        
        <!-- Fun environment - Everything scaled for tiny player -->
        <!-- Giant mushrooms -->
        <a-cylinder position="-15 0.1 -20" radius="0.4" height="0.8" color="#8B4513" shadow></a-cylinder>
        <a-sphere position="-15 0.6 -20" radius="0.6" color="#FF6B6B" shadow></a-sphere>
        <a-sphere position="-14.5 1.0 -20.5" radius="0.3" color="#FF8E8E" shadow></a-sphere>
        
        <a-cylinder position="20 0.1 -15" radius="0.5" height="1.0" color="#8B4513" shadow></a-cylinder>
        <a-sphere position="20 0.7 -15" radius="0.7" color="#4ECDC4" shadow></a-sphere>
        
        <!-- Tiny houses -->
        <a-box position="-25 0.2 -30" width="3" height="0.4" depth="3" color="#A0522D" shadow></a-box>
        <a-box position="-25 0.8 -30" width="2.5" height="1.2" depth="2.5" color="#DEB887" shadow></a-box>
        <a-cone position="-25 1.6 -30" radius-bottom="1.5" radius-top="0" height="1.2" color="#8B4513" shadow></a-cone>
        
        <!-- Colorful crystals -->
        <a-cylinder position="30 0.1 20" radius="0.3" height="1.5" color="#FF69B4" shadow></a-cylinder>
        <a-cone position="30 1.0 20" radius-bottom="0.4" radius-top="0" height="0.8" color="#FF1493" shadow></a-cone>
        
        <!-- Tiny pond -->
        <a-circle position="10 0.05 40" rotation="-90 0 0" radius="3" color="#4169E1" material="opacity: 0.6; transparent: true"></a-circle>
        
        <!-- Stepping stones -->
        <a-cylinder position="8 0.1 38" radius="0.4" height="0.1" color="#D3D3D3" shadow></a-cylinder>
        <a-cylinder position="10 0.1 36" radius="0.4" height="0.1" color="#D3D3D3" shadow></a-cylinder>
        <a-cylinder position="12 0.1 38" radius="0.4" height="0.1" color="#D3D3D3" shadow></a-cylinder>
    </a-scene>
    
    <script>
        // Game State
        let gameRunning = true;
        let joystickActive = false;
        let joystickVector = { x: 0, y: 0 };
        let isJumping = false;
        let currentAnimation = 'idle';
        let lastMovementTime = Date.now();
        let movementThreshold = 100; // ms before considering idle
        
        // Movement speed adjusted for tiny player
        let moveSpeed = 0.06;
        const walkSpeed = 0.04;
        const runSpeed = 0.08;
        
        // DOM Elements
        const posXEl = document.getElementById('pos-x');
        const posZEl = document.getElementById('pos-z');
        const currentAnimEl = document.getElementById('current-animation');
        
        // Touch Controls
        const moveJoystick = document.getElementById('move-joystick');
        const joystickHandle = document.getElementById('joystick-handle');
        const jumpBtn = document.getElementById('jump-btn');
        const shootBtn = document.getElementById('shoot-btn');
        const grenadeBtn = document.getElementById('grenade-btn');
        
        // Animation Controls
        const animBtns = document.querySelectorAll('.anim-btn');
        const playbackSpeed = document.getElementById('playback-speed');
        const speedValue = document.getElementById('speed-value');
        
        // A-Frame Elements
        const scene = document.querySelector('a-scene');
        const cameraRig = document.getElementById('camera-rig');
        const camera = document.getElementById('camera');
        const playerModel = document.getElementById('player-model-instance');
        
        // Animation mapping based on your gLTF viewer
        const animationMap = {
            't-pose': 't-pose',
            'run-forward': 'run-forward',
            'throw-grenade': 'throw-grenade',
            'run-right': 'run-right',
            'idle': 'idle',
            'walk-forward': 'walk-forward',
            'run-left': 'run-left',
            'walk-right': 'walk-right',
            'run-backwards': 'run-backwards',
            'walk-backwards': 'walk-backwards',
            'walk-left': 'walk-left',
            'reloading': 'reloading',
            'jump': 'jump',
            'hit-reaction-1': 'hit-reaction-1',
            'shoot-rifle': 'shoot-rifle',
            'hit-reaction-2': 'hit-reaction-2',
            'shoot-pistol': 'shoot-pistol'
        };
        
        // Joystick Logic
        moveJoystick.addEventListener('touchstart', (e) => {
            e.preventDefault();
            joystickActive = true;
            lastMovementTime = Date.now();
            updateJoystick(e.touches[0]);
        });
        
        moveJoystick.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (joystickActive) {
                lastMovementTime = Date.now();
                updateJoystick(e.touches[0]);
            }
        });
        
        moveJoystick.addEventListener('touchend', (e) => {
            e.preventDefault();
            joystickActive = false;
            joystickVector = { x: 0, y: 0 };
            joystickHandle.style.transform = 'translate(0px, 0px)';
            lastMovementTime = Date.now();
        });
        
        function updateJoystick(touch) {
            const rect = moveJoystick.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            let deltaX = touch.clientX - centerX;
            let deltaY = touch.clientY - centerY;
            
            // Limit to joystick radius
            const maxDistance = 40;
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            
            if (distance > maxDistance) {
                deltaX = (deltaX / distance) * maxDistance;
                deltaY = (deltaY / distance) * maxDistance;
            }
            
            joystickHandle.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
            
            // Normalize vector (-1 to 1)
            joystickVector.x = deltaX / maxDistance;
            joystickVector.y = deltaY / maxDistance;
        }
        
        // Animation Control Functions
        function setAnimation(animName) {
            if (!playerModel) return;
            
            // Update UI
            animBtns.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.anim === animName) {
                    btn.classList.add('active');
                }
            });
            
            currentAnimEl.textContent = `Animation: ${animName}`;
            currentAnimation = animName;
            
            // Set animation on model
            playerModel.setAttribute('animation-mixer', {
                clip: animName,
                loop: animName.includes('hit') || animName.includes('jump') ? 'once' : 'repeat',
                timeScale: parseFloat(playbackSpeed.value)
            });
        }
        
        // Handle movement-based animations
        function updateMovementAnimation() {
            if (isJumping) return; // Don't override jump animation
            
            const timeSinceLastMove = Date.now() - lastMovementTime;
            
            if (!joystickActive || timeSinceLastMove > movementThreshold) {
                // Idle
                if (currentAnimation !== 'idle') {
                    setAnimation('idle');
                }
                return;
            }
            
            // Determine movement direction and speed
            const moveMagnitude = Math.sqrt(joystickVector.x * joystickVector.x + joystickVector.y * joystickVector.y);
            const isRunning = moveMagnitude > 0.7;
            
            // Determine direction-based animation
            if (Math.abs(joystickVector.x) > Math.abs(joystickVector.y)) {
                // Strafe left/right
                if (joystickVector.x > 0) {
                    setAnimation(isRunning ? 'run-right' : 'walk-right');
                } else {
                    setAnimation(isRunning ? 'run-left' : 'walk-left');
                }
            } else {
                // Forward/backward
                if (joystickVector.y > 0) {
                    setAnimation(isRunning ? 'run-forward' : 'walk-forward');
                } else {
                    setAnimation(isRunning ? 'run-backwards' : 'walk-backwards');
                }
            }
        }
        
        // Jump Function with proper physics
        function jump() {
            if (isJumping) return;
            
            let pos = cameraRig.getAttribute('position');
            if (pos.y <= 0.35) {
                isJumping = true;
                setAnimation('jump');
                
                let jumpStartTime = Date.now();
                let startY = pos.y;
                const jumpHeight = 0.3;
                const jumpDuration = 400; // ms
                
                function jumpAnimation() {
                    let elapsed = Date.now() - jumpStartTime;
                    let progress = Math.min(elapsed / jumpDuration, 1);
                    
                    if (progress >= 1) {
                        // Jump complete
                        pos.y = startY;
                        cameraRig.setAttribute('position', pos);
                        isJumping = false;
                        updateMovementAnimation(); // Return to appropriate animation
                        return;
                    }
                    
                    // Parabolic jump curve
                    let jumpProgress = Math.sin(progress * Math.PI);
                    pos.y = startY + (jumpHeight * jumpProgress);
                    cameraRig.setAttribute('position', pos);
                    
                    requestAnimationFrame(jumpAnimation);
                }
                
                jumpAnimation();
            }
        }
        
        // Shoot function
        function shoot() {
            if (isJumping) return;
            setAnimation('shoot-rifle');
            setTimeout(() => {
                updateMovementAnimation();
            }, 500);
        }
        
        // Throw grenade function
        function throwGrenade() {
            if (isJumping) return;
            setAnimation('throw-grenade');
            setTimeout(() => {
                updateMovementAnimation();
            }, 800);
        }
        
        // Move player based on joystick
        function movePlayer() {
            if (!gameRunning || !joystickActive || isJumping) return;
            
            const pos = cameraRig.getAttribute('position');
            const rot = camera.getAttribute('rotation');
            
            // Calculate movement speed based on joystick magnitude
            const moveMagnitude = Math.sqrt(joystickVector.x * joystickVector.x + joystickVector.y * joystickVector.y);
            const currentSpeed = moveMagnitude > 0.7 ? runSpeed : walkSpeed;
            
            // Move relative to camera direction
            const radY = THREE.MathUtils.degToRad(rot.y);
            
            // Forward/backward movement
            if (joystickVector.y !== 0) {
                pos.x += Math.sin(radY) * joystickVector.y * currentSpeed * -1;
                pos.z += Math.cos(radY) * joystickVector.y * currentSpeed * -1;
            }
            
            // Left/right movement (strafe)
            if (joystickVector.x !== 0) {
                pos.x += Math.sin(radY + Math.PI/2) * joystickVector.x * currentSpeed;
                pos.z += Math.cos(radY + Math.PI/2) * joystickVector.x * currentSpeed;
            }
            
            // Keep player within bounds
            pos.x = Math.max(-90, Math.min(90, pos.x));
            pos.z = Math.max(-90, Math.min(90, pos.z));
            
            cameraRig.setAttribute('position', pos);
            
            // Update position display
            posXEl.textContent = Math.round(pos.x * 10) / 10;
            posZEl.textContent = Math.round(pos.z * 10) / 10;
        }
        
        // Game Loop
        function gameLoop() {
            if (gameRunning) {
                movePlayer();
                updateMovementAnimation();
            }
            requestAnimationFrame(gameLoop);
        }
        
        // Event Listeners
        jumpBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            jump();
        });
        
        shootBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            shoot();
        });
        
        grenadeBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            throwGrenade();
        });
        
        // Animation button listeners
        animBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const animName = btn.dataset.anim;
                setAnimation(animName);
            });
        });
        
        // Playback speed control
        playbackSpeed.addEventListener('input', (e) => {
            const speed = e.target.value;
            speedValue.textContent = speed;
            if (playerModel) {
                playerModel.setAttribute('animation-mixer', 'timeScale', parseFloat(speed));
            }
        });
        
        // Keyboard controls for debugging
        window.addEventListener('keydown', (e) => {
            if (!gameRunning) return;
            
            switch(e.key) {
                case ' ':
                    e.preventDefault();
                    jump();
                    break;
                case '1':
                    setAnimation('idle');
                    break;
                case '2':
                    setAnimation('walk-forward');
                    break;
                case '3':
                    setAnimation('run-forward');
                    break;
                case '4':
                    setAnimation('shoot-pistol');
                    break;
            }
        });
        
        // Prevent default touch behaviors
        document.addEventListener('touchmove', (e) => {
            if (e.target.closest('#touch-controls')) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // Initialize when scene loads
        scene.addEventListener('loaded', () => {
            console.log('Scene loaded - Tiny player world with animations!');
            
            // Set initial position
            cameraRig.setAttribute('position', { x: 0, y: 0.3, z: 0 });
            
            // Set initial animation
            setTimeout(() => {
                setAnimation('idle');
            }, 1000);
            
            // Start game loop
            gameLoop();
        });
        
        // Add error handling for model loading
        if (playerModel) {
            playerModel.addEventListener('error', (e) => {
                console.error('Failed to load player model! Using fallback...');
                // Create a simple animated cube as fallback
                const fallback = document.createElement('a-box');
                fallback.setAttribute('color', 'red');
                fallback.setAttribute('scale', '0.5 0.8 0.3');
                fallback.setAttribute('animation', 'property: rotation; to: 0 360 0; dur: 2000; easing: linear; loop: true');
                document.querySelector('#player').appendChild(fallback);
            });
        }
        
        // Add floating particles
        function createFloatingParticles() {
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const particle = document.createElement('a-sphere');
                    particle.setAttribute('radius', '0.05');
                    particle.setAttribute('color', `hsl(${Math.random() * 360}, 80%, 70%)`);
                    particle.setAttribute('position', {
                        x: (Math.random() - 0.5) * 80,
                        y: Math.random() * 5,
                        z: (Math.random() - 0.5) * 80
                    });
                    particle.setAttribute('animation', 'property: position; to: 0 10 0; dur: 5000; easing: linear; loop: true');
                    particle.setAttribute('material', 'transparent: true; opacity: 0.6');
                    scene.appendChild(particle);
                }, i * 200);
            }
        }
        
        // Create particles after scene loads
        scene.addEventListener('loaded', createFloatingParticles);
    </script>
</body>
    </html>
