<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mini World Explorer - Fixed Version</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000; transition: opacity 0.5s;
            color: white; text-align: center;
        }
        
        .loading-content {
            background: rgba(0,0,0,0.5); padding: 40px;
            border-radius: 20px; backdrop-filter: blur(10px);
        }
        
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-radius: 50%; border-top-color: #4a9eff;
            animation: spin 1s ease-in-out infinite;
            margin: 20px auto;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #loading-status {
            font-size: 18px; margin-top: 20px;
            padding: 10px 20px; background: rgba(74, 158, 255, 0.3);
            border-radius: 30px;
        }
        
        #touch-controls {
            position: fixed; bottom: 30px; left: 0; right: 0;
            display: flex; justify-content: space-between; padding: 20px;
            pointer-events: none; z-index: 1000;
        }
        
        .joystick-area {
            pointer-events: auto; width: 120px; height: 120px;
            background: rgba(30, 30, 50, 0.8); border-radius: 60px;
            backdrop-filter: blur(5px); border: 2px solid #4a9eff;
            display: flex; justify-content: center; align-items: center;
            touch-action: none;
        }
        
        .joystick {
            width: 50px; height: 50px; background: white;
            border-radius: 25px; border: 2px solid #4a9eff;
            transition: transform 0.05s;
        }
        
        .action-buttons {
            display: flex; gap: 15px; pointer-events: auto;
        }
        
        .action-btn {
            width: 70px; height: 70px; border-radius: 35px;
            background: rgba(30, 30, 50, 0.8); border: 3px solid #4a9eff;
            color: white; font-size: 14px; font-weight: bold;
            backdrop-filter: blur(5px); cursor: pointer;
        }
        
        .action-btn:active { transform: scale(0.9); background: #4a9eff; }
        #jump-btn { border-color: #ffaa00; }
        #shoot-btn { border-color: #ff4757; }
        #grenade-btn { border-color: #9f7aea; }
        
        #hud {
            position: fixed; top: 20px; left: 20px; color: white;
            background: rgba(30, 30, 50, 0.8); padding: 15px 25px;
            border-radius: 10px; backdrop-filter: blur(5px);
            border: 2px solid #4a9eff; z-index: 1000;
        }
        
        #hud .title { font-size: 24px; font-weight: bold; color: #4a9eff; }
        #anim-status {
            position: fixed; bottom: 200px; left: 50%;
            transform: translateX(-50%);
            color: #4a9eff; font-size: 24px; font-weight: bold;
            background: rgba(30, 30, 50, 0.9); padding: 10px 30px;
            border-radius: 40px; border: 2px solid #4a9eff;
            z-index: 1000; backdrop-filter: blur(5px);
        }
        
        #controls-hint {
            position: fixed; bottom: 120px; left: 50%;
            transform: translateX(-50%);
            color: white; background: rgba(30, 30, 50, 0.8);
            padding: 10px 25px; border-radius: 30px;
            border: 1px solid #4a9eff; z-index: 1000;
        }
        
        #error-message {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #ff4757; background: rgba(0,0,0,0.9);
            padding: 20px; border-radius: 10px;
            z-index: 3000; display: none;
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="loading-content">
            <h1>üåç MINI WORLD EXPLORER</h1>
            <h3>with YOUR character model</h3>
            <div class="spinner"></div>
            <div id="loading-status">Loading Player.glb...</div>
        </div>
    </div>

    <div id="error-message"></div>

    <div id="hud">
        <div class="title">‚öîÔ∏è MINI EXPLORER</div>
        <div>X: <span id="pos-x">0.0</span> Z: <span id="pos-z">0.0</span></div>
    </div>
    
    <div id="anim-status">IDLE</div>
    <div id="controls-hint">üëÜ Joystick to move | Buttons for actions</div>

    <div id="touch-controls">
        <div class="joystick-area" id="move-joystick">
            <div class="joystick" id="joystick-handle"></div>
        </div>
        
        <div class="action-buttons">
            <button class="action-btn" id="jump-btn">ü¶ò JUMP</button>
            <button class="action-btn" id="shoot-btn">üî´ SHOOT</button>
            <button class="action-btn" id="grenade-btn">üí£ GRENADE</button>
        </div>
    </div>
    
    <a-scene background="color: #1a1a2e" shadow="type: pcfsoft" vr-mode-ui="enabled: false">
        <a-assets>
            <a-asset-item id="player-model" src="Player.glb"></a-asset-item>
            <a-asset-item id="gun-model" src="Mpsd.glb"></a-asset-item>
            <img id="ground-texture" src="https://cdn.aframe.io/aframe-brand/examples/ground.jpg">
        </a-assets>

        <!-- SIMPLE CAMERA SYSTEM: Camera directly follows player -->
        <a-entity id="player" position="0 0.06 0">
            <a-gltf-model 
                id="player-model-instance" 
                src="#player-model"
                scale="0.003 0.003 0.003"
                animation-mixer>
            </a-gltf-model>
            
            <!-- Gun placed at approximate hand position (will be adjusted by JS) -->
            <a-entity id="gun" position="0.3 0.3 0.3" rotation="0 90 0" scale="0.0025 0.0025 0.0025">
                <a-gltf-model src="#gun-model" visible="false" id="gun-model-instance"></a-gltf-model>
            </a-entity>
        </a-entity>

        <!-- Camera positioned relative to player -->
        <a-camera id="camera" wasd-controls="enabled: false" look-controls="enabled: true" position="0 0.3 0.6"></a-camera>
        
        <!-- Lighting -->
        <a-light type="ambient" intensity="0.6"></a-light>
        <a-light type="directional" position="2 5 3" intensity="1.5" castshadow="true"></a-light>
        
        <!-- Ground -->
        <a-plane rotation="-90 0 0" width="200" height="200" material="src: #ground-texture; repeat: 40 40" receive-shadow></a-plane>
        
        <!-- Simple objects -->
        <a-box position="2 0.5 2" width="1" height="1" depth="1" color="#FF6B6B" shadow></a-box>
        <a-box position="-2 0.5 -2" width="1" height="1" depth="1" color="#4ECDC4" shadow></a-box>
        <a-cylinder position="3 0.5 -3" radius="0.5" height="1" color="#FFE66D" shadow></a-cylinder>
    </a-scene>
    
    <script>
        // SIMPLIFIED VERSION - NO COMPLEX COMPONENTS
        (function() {
            console.log('Starting Mini World Explorer...');
            
            // Get elements
            const loadingScreen = document.getElementById('loading-screen');
            const loadingStatus = document.getElementById('loading-status');
            const animStatus = document.getElementById('anim-status');
            const posX = document.getElementById('pos-x');
            const posZ = document.getElementById('pos-z');
            const errorMsg = document.getElementById('error-message');
            
            // State
            let joystickActive = false;
            let joystickX = 0;
            let joystickY = 0;
            let isJumping = false;
            let playerY = 0.06;
            
            // Movement speed
            const MOVE_SPEED = 0.02;
            
            // Get A-Frame elements
            const scene = document.querySelector('a-scene');
            const player = document.getElementById('player');
            const camera = document.getElementById('camera');
            const playerModel = document.getElementById('player-model-instance');
            const gun = document.getElementById('gun');
            const gunModel = document.getElementById('gun-model-instance');
            
            // Simple joystick setup
            const moveJoystick = document.getElementById('move-joystick');
            const joystickHandle = document.getElementById('joystick-handle');
            
            moveJoystick.addEventListener('touchstart', (e) => {
                e.preventDefault();
                joystickActive = true;
                updateJoystick(e.touches[0]);
            });
            
            moveJoystick.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (joystickActive) updateJoystick(e.touches[0]);
            });
            
            moveJoystick.addEventListener('touchend', (e) => {
                e.preventDefault();
                joystickActive = false;
                joystickX = 0;
                joystickY = 0;
                joystickHandle.style.transform = 'translate(0px, 0px)';
                if (animStatus && !isJumping) animStatus.textContent = 'IDLE';
            });
            
            function updateJoystick(touch) {
                const rect = moveJoystick.getBoundingClientRect();
                const centerX = rect.left + rect.width/2;
                const centerY = rect.top + rect.height/2;
                
                let deltaX = touch.clientX - centerX;
                let deltaY = touch.clientY - centerY;
                
                const maxDistance = 40;
                const distance = Math.sqrt(deltaX*deltaX + deltaY*deltaY);
                
                if (distance > maxDistance) {
                    deltaX = (deltaX/distance) * maxDistance;
                    deltaY = (deltaY/distance) * maxDistance;
                }
                
                joystickHandle.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
                joystickX = deltaX / maxDistance;
                joystickY = deltaY / maxDistance;
                
                if (animStatus && !isJumping) {
                    animStatus.textContent = Math.abs(joystickX) > 0.7 || Math.abs(joystickY) > 0.7 ? 'RUNNING' : 'WALKING';
                }
            }
            
            // Action buttons
            document.getElementById('jump-btn').addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (!isJumping) {
                    isJumping = true;
                    animStatus.textContent = 'JUMP';
                    playerY = 0.06;
                    
                    // Simple jump animation
                    let jumpTime = 0;
                    const jumpInterval = setInterval(() => {
                        jumpTime += 50;
                        const progress = jumpTime / 400; // 400ms jump
                        
                        if (progress >= 1) {
                            clearInterval(jumpInterval);
                            player.setAttribute('position', {x: player.getAttribute('position').x, y: 0.06, z: player.getAttribute('position').z});
                            isJumping = false;
                            if (!joystickActive) animStatus.textContent = 'IDLE';
                        } else {
                            const jumpY = 0.06 + Math.sin(progress * Math.PI) * 0.08;
                            player.setAttribute('position', {x: player.getAttribute('position').x, y: jumpY, z: player.getAttribute('position').z});
                        }
                    }, 50);
                }
            });
            
            document.getElementById('shoot-btn').addEventListener('touchstart', (e) => {
                e.preventDefault();
                animStatus.textContent = 'SHOOT';
                
                // Muzzle flash
                if (gunModel) {
                    gunModel.setAttribute('material', 'emissive', '#FF5500');
                    gunModel.setAttribute('material', 'emissiveIntensity', '2.0');
                    gunModel.setAttribute('visible', 'true');
                    
                    setTimeout(() => {
                        gunModel.setAttribute('material', 'emissive', '#000000');
                        gunModel.setAttribute('material', 'emissiveIntensity', '0');
                    }, 100);
                }
                
                setTimeout(() => {
                    if (!joystickActive && !isJumping) animStatus.textContent = 'IDLE';
                }, 500);
            });
            
            document.getElementById('grenade-btn').addEventListener('touchstart', (e) => {
                e.preventDefault();
                animStatus.textContent = 'GRENADE';
                setTimeout(() => {
                    if (!joystickActive && !isJumping) animStatus.textContent = 'IDLE';
                }, 800);
            });
            
            // Handle model loading
            let modelsLoaded = 0;
            
            if (playerModel) {
                playerModel.addEventListener('model-loaded', () => {
                    console.log('‚úÖ Player model loaded');
                    modelsLoaded++;
                    loadingStatus.textContent = '‚úì Player loaded, loading gun...';
                    
                    // Make gun visible after player loads
                    setTimeout(() => {
                        if (gunModel) gunModel.setAttribute('visible', 'true');
                    }, 500);
                    
                    checkAllLoaded();
                });
                
                playerModel.addEventListener('error', (e) => {
                    console.error('Player model error:', e);
                    loadingStatus.textContent = '‚ö†Ô∏è Using simple player';
                    modelsLoaded++;
                    checkAllLoaded();
                });
            }
            
            if (gunModel) {
                gunModel.addEventListener('model-loaded', () => {
                    console.log('‚úÖ Gun model loaded');
                    modelsLoaded++;
                    loadingStatus.textContent = '‚úì Gun loaded';
                    checkAllLoaded();
                });
                
                gunModel.addEventListener('error', (e) => {
                    console.error('Gun model error:', e);
                    loadingStatus.textContent = '‚ö†Ô∏è Using simple gun';
                    
                    // Create simple gun as fallback
                    const simpleGun = document.createElement('a-box');
                    simpleGun.setAttribute('width', '0.2');
                    simpleGun.setAttribute('height', '0.1');
                    simpleGun.setAttribute('depth', '0.4');
                    simpleGun.setAttribute('color', '#333');
                    simpleGun.setAttribute('position', '0 0 0');
                    gun.appendChild(simpleGun);
                    
                    modelsLoaded++;
                    checkAllLoaded();
                });
            }
            
            function checkAllLoaded() {
                if (modelsLoaded >= 2) {
                    loadingStatus.textContent = '‚ú® World ready!';
                    
                    // Try to attach gun to hand bone
                    setTimeout(() => {
                        try {
                            const model = playerModel.getObject3D('mesh');
                            if (model) {
                                console.log('Searching for hand bone...');
                                model.traverse((node) => {
                                    if (node.isBone && node.name.toLowerCase().includes('hand')) {
                                        console.log('Found hand bone:', node.name);
                                        // Reparent gun to bone
                                        const gunObj = gun.object3D;
                                        const parent = gunObj.parent;
                                        if (parent) parent.remove(gunObj);
                                        node.add(gunObj);
                                        gunObj.position.set(0.01, 0.01, 0.005);
                                        gunObj.rotation.set(0, Math.PI/2, 0);
                                    }
                                });
                            }
                        } catch(e) {
                            console.log('Could not attach to bone, using default position');
                        }
                    }, 1000);
                    
                    setTimeout(() => {
                        loadingScreen.style.opacity = '0';
                        setTimeout(() => {
                            loadingScreen.style.display = 'none';
                        }, 500);
                    }, 1000);
                }
            }
            
            // SIMPLE CAMERA FOLLOW - Direct update every frame
            function updateCamera() {
                if (!player || !camera) return;
                
                const playerPos = player.getAttribute('position');
                
                // Camera follows player position exactly
                camera.setAttribute('position', {
                    x: playerPos.x,
                    y: playerPos.y + 0.3,
                    z: playerPos.z + 0.6
                });
                
                // Update HUD
                if (posX) posX.textContent = Math.round(playerPos.x * 10) / 10;
                if (posZ) posZ.textContent = Math.round(playerPos.z * 10) / 10;
            }
            
            // MOVEMENT - Direct position update
            function movePlayer() {
                if (!joystickActive || isJumping || !player || !camera) return;
                
                const playerPos = player.getAttribute('position');
                const cameraRot = camera.getAttribute('rotation');
                
                const radY = THREE.MathUtils.degToRad(cameraRot.y);
                
                // Forward/back
                if (joystickY !== 0) {
                    playerPos.x += Math.sin(radY) * joystickY * MOVE_SPEED * -1;
                    playerPos.z += Math.cos(radY) * joystickY * MOVE_SPEED * -1;
                }
                
                // Strafe
                if (joystickX !== 0) {
                    playerPos.x += Math.sin(radY + Math.PI/2) * joystickX * MOVE_SPEED;
                    playerPos.z += Math.cos(radY + Math.PI/2) * joystickX * MOVE_SPEED;
                }
                
                // Keep in bounds
                playerPos.x = Math.max(-45, Math.min(45, playerPos.x));
                playerPos.z = Math.max(-45, Math.min(45, playerPos.z));
                
                player.setAttribute('position', playerPos);
            }
            
            // Simple animation loop
            function gameLoop() {
                movePlayer();
                updateCamera();
                requestAnimationFrame(gameLoop);
            }
            
            // Start when scene loads
            scene.addEventListener('loaded', () => {
                console.log('Scene loaded, starting game loop');
                gameLoop();
                
                // Set initial idle animation
                setTimeout(() => {
                    if (animStatus) animStatus.textContent = 'IDLE';
                }, 500);
            });
            
            // Fallback in case scene loaded event already fired
            setTimeout(() => {
                if (!loadingScreen.style.display) {
                    console.log('Force starting...');
                    gameLoop();
                }
            }, 3000);
            
            // Error handler
            window.addEventListener('error', (e) => {
                console.error('Global error:', e.error);
                errorMsg.style.display = 'block';
                errorMsg.innerHTML = 'Error: ' + e.error.message;
                loadingStatus.textContent = '‚ö†Ô∏è Error - Check console';
            });
        })();
    </script>
</body>
    </html>
