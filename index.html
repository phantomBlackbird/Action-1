<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mini World Explorer - Proper Animations</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000; transition: opacity 0.5s;
            color: white; text-align: center;
        }
        
        .loading-content {
            background: rgba(0,0,0,0.5); padding: 40px;
            border-radius: 20px; backdrop-filter: blur(10px);
        }
        
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-radius: 50%; border-top-color: #4a9eff;
            animation: spin 1s ease-in-out infinite;
            margin: 20px auto;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #loading-status {
            font-size: 18px; margin-top: 20px;
            padding: 10px 20px; background: rgba(74, 158, 255, 0.3);
            border-radius: 30px;
        }
        
        #touch-controls {
            position: fixed; bottom: 30px; left: 0; right: 0;
            display: flex; justify-content: space-between; padding: 20px;
            pointer-events: none; z-index: 1000;
        }
        
        .joystick-area {
            pointer-events: auto; width: 120px; height: 120px;
            background: rgba(30, 30, 50, 0.8); border-radius: 60px;
            backdrop-filter: blur(5px); border: 2px solid #4a9eff;
            display: flex; justify-content: center; align-items: center;
            touch-action: none;
            box-shadow: 0 0 20px rgba(74, 158, 255, 0.3);
        }
        
        .joystick {
            width: 50px; height: 50px; background: white;
            border-radius: 25px; border: 2px solid #4a9eff;
            transition: transform 0.05s;
        }
        
        .action-buttons {
            display: flex; gap: 15px; pointer-events: auto;
            flex-wrap: wrap; justify-content: flex-end;
            max-width: 300px;
        }
        
        .action-btn {
            width: 70px; height: 70px; border-radius: 35px;
            background: rgba(30, 30, 50, 0.8); border: 3px solid #4a9eff;
            color: white; font-size: 14px; font-weight: bold;
            backdrop-filter: blur(5px); cursor: pointer;
            transition: all 0.1s;
            box-shadow: 0 0 15px rgba(74, 158, 255, 0.3);
        }
        
        .action-btn:active { transform: scale(0.9); background: #4a9eff; }
        #jump-btn { border-color: #ffaa00; }
        #shoot-btn { border-color: #ff4757; }
        #grenade-btn { border-color: #9f7aea; }
        
        #hud {
            position: fixed; top: 20px; left: 20px; color: white;
            background: rgba(30, 30, 50, 0.8); padding: 15px 25px;
            border-radius: 10px; backdrop-filter: blur(5px);
            border: 2px solid #4a9eff; z-index: 1000;
        }
        
        #hud .title { font-size: 24px; font-weight: bold; color: #4a9eff; }
        
        #anim-status {
            position: fixed; bottom: 200px; left: 50%;
            transform: translateX(-50%);
            color: #4a9eff; font-size: 24px; font-weight: bold;
            background: rgba(30, 30, 50, 0.9); padding: 10px 30px;
            border-radius: 40px; border: 2px solid #4a9eff;
            z-index: 1000; backdrop-filter: blur(5px);
            box-shadow: 0 0 30px rgba(74, 158, 255, 0.5);
            min-width: 200px;
            text-align: center;
        }
        
        #controls-hint {
            position: fixed; bottom: 120px; left: 50%;
            transform: translateX(-50%);
            color: white; background: rgba(30, 30, 50, 0.8);
            padding: 10px 25px; border-radius: 30px;
            border: 1px solid #4a9eff; z-index: 1000;
        }
        
        #debug-animation {
            position: fixed; top: 20px; right: 20px;
            color: #4a9eff; background: rgba(30, 30, 50, 0.8);
            padding: 10px; border-radius: 10px;
            border: 1px solid #4a9eff; z-index: 1000;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="loading-content">
            <h1>üåç MINI WORLD EXPLORER</h1>
            <h3>with YOUR character model</h3>
            <div class="spinner"></div>
            <div id="loading-status">Loading Player.glb...</div>
        </div>
    </div>

    <div id="hud">
        <div class="title">‚öîÔ∏è MINI EXPLORER</div>
        <div>X: <span id="pos-x">0.0</span> Z: <span id="pos-z">0.0</span></div>
    </div>
    
    <div id="anim-status">IDLE</div>
    <div id="controls-hint">üëÜ Joystick to move | Buttons for actions</div>
    <div id="debug-animation">Available animations: loading...</div>

    <div id="touch-controls">
        <div class="joystick-area" id="move-joystick">
            <div class="joystick" id="joystick-handle"></div>
        </div>
        
        <div class="action-buttons">
            <button class="action-btn" id="jump-btn">ü¶ò JUMP</button>
            <button class="action-btn" id="shoot-btn">üî´ SHOOT</button>
            <button class="action-btn" id="grenade-btn">üí£ GRENADE</button>
        </div>
    </div>
    
    <a-scene background="color: #1a1a2e" shadow="type: pcfsoft" vr-mode-ui="enabled: false">
        <a-assets>
            <a-asset-item id="player-model" src="Player.glb"></a-asset-item>
            <a-asset-item id="gun-model" src="Mpsd.glb"></a-asset-item>
            <img id="ground-texture" src="https://cdn.aframe.io/aframe-brand/examples/ground.jpg">
        </a-assets>

        <!-- Player Character -->
        <a-entity id="player" position="0 0.06 0">
            <a-gltf-model 
                id="player-model-instance" 
                src="#player-model"
                scale="0.003 0.003 0.003"
                animation-mixer="clip: idle; loop: repeat; crossFadeDuration: 0.2">
            </a-gltf-model>
            
            <!-- Gun -->
            <a-entity id="gun" position="0.3 0.3 0.3" rotation="0 90 0" scale="0.0025 0.0025 0.0025">
                <a-gltf-model id="gun-model-instance" src="#gun-model"></a-gltf-model>
            </a-entity>
        </a-entity>

        <!-- Camera -->
        <a-camera id="camera" wasd-controls="enabled: false" look-controls="enabled: true" position="0 0.3 0.6"></a-camera>
        
        <!-- Lighting -->
        <a-light type="ambient" intensity="0.6"></a-light>
        <a-light type="directional" position="2 5 3" intensity="1.5" castshadow="true"></a-light>
        
        <!-- Ground -->
        <a-plane rotation="-90 0 0" width="200" height="200" material="src: #ground-texture; repeat: 40 40" receive-shadow></a-plane>
        
        <!-- Simple objects -->
        <a-box position="2 0.5 2" width="1" height="1" depth="1" color="#FF6B6B" shadow></a-box>
        <a-box position="-2 0.5 -2" width="1" height="1" depth="1" color="#4ECDC4" shadow></a-box>
        <a-cylinder position="3 0.5 -3" radius="0.5" height="1" color="#FFE66D" shadow></a-cylinder>
    </a-scene>
    
    <script>
        (function() {
            console.log('Starting Mini World Explorer with proper animations...');
            
            // ===== ANIMATION MAPPING =====
            // Based on your screenshot, exact animation names from Player.glb
            const ANIMATIONS = {
                // Movement animations
                IDLE: 'idle',
                RUN_FORWARD: 'run-forward',
                RUN_BACKWARDS: 'run-backwards',
                RUN_LEFT: 'run-left',
                RUN_RIGHT: 'run-right',
                WALK_FORWARD: 'walk-forward',
                WALK_BACKWARDS: 'walk-backwards',
                WALK_LEFT: 'walk-left',
                WALK_RIGHT: 'walk-right',
                
                // Action animations (one-shot)
                JUMP: 'jump',
                SHOOT_RIFLE: 'shoot-rifle',
                SHOOT_PISTOL: 'shoot-pistol',
                THROW_GRENADE: 'throw-grenade',
                RELOADING: 'reloading',
                HIT_REACTION_1: 'hit-reaction-1',
                HIT_REACTION_2: 'hit-reaction-2',
                
                // T-pose (for debugging)
                T_POSE: 't-pose'
            };
            
            // Animation durations (in milliseconds) for one-shot animations
            const ANIMATION_DURATIONS = {
                [ANIMATIONS.JUMP]: 500,
                [ANIMATIONS.SHOOT_RIFLE]: 600,
                [ANIMATIONS.SHOOT_PISTOL]: 500,
                [ANIMATIONS.THROW_GRENADE]: 800,
                [ANIMATIONS.RELOADING]: 700,
                [ANIMATIONS.HIT_REACTION_1]: 500,
                [ANIMATIONS.HIT_REACTION_2]: 500
            };
            
            // ===== DOM Elements =====
            const loadingScreen = document.getElementById('loading-screen');
            const loadingStatus = document.getElementById('loading-status');
            const animStatus = document.getElementById('anim-status');
            const debugAnim = document.getElementById('debug-animation');
            const posX = document.getElementById('pos-x');
            const posZ = document.getElementById('pos-z');
            
            // ===== State =====
            let joystickActive = false;
            let joystickX = 0;
            let joystickY = 0;
            let isJumping = false;
            let currentAnimation = ANIMATIONS.IDLE;
            let animationTimeout = null;
            let availableAnimations = [];
            
            // Movement speed
            const WALK_SPEED = 0.015;
            const RUN_SPEED = 0.025;
            
            // ===== A-Frame Elements =====
            const scene = document.querySelector('a-scene');
            const player = document.getElementById('player');
            const camera = document.getElementById('camera');
            const playerModel = document.getElementById('player-model-instance');
            const gun = document.getElementById('gun');
            const gunModel = document.getElementById('gun-model-instance');
            
            // ===== Animation Control =====
            function setAnimation(animName, isOneShot = false) {
                if (!playerModel || !animName) return;
                
                // Don't interrupt jump with other animations
                if (isJumping && animName !== ANIMATIONS.JUMP) return;
                
                // Clear any pending timeout
                if (animationTimeout) {
                    clearTimeout(animationTimeout);
                    animationTimeout = null;
                }
                
                // Update current animation
                currentAnimation = animName;
                
                // Update UI
                let displayName = animName.toUpperCase();
                if (animName === ANIMATIONS.IDLE) displayName = 'IDLE';
                else if (animName.includes('run')) displayName = 'üèÉ RUNNING';
                else if (animName.includes('walk')) displayName = 'üö∂ WALKING';
                else if (animName === ANIMATIONS.SHOOT_RIFLE || animName === ANIMATIONS.SHOOT_PISTOL) displayName = 'üî´ SHOOTING';
                else if (animName === ANIMATIONS.JUMP) displayName = 'ü¶ò JUMPING';
                else if (animName === ANIMATIONS.THROW_GRENADE) displayName = 'üí£ GRENADE';
                else if (animName === ANIMATIONS.RELOADING) displayName = 'üîÑ RELOADING';
                else if (animName.includes('hit')) displayName = 'üí• HIT';
                
                animStatus.textContent = displayName;
                
                // Set the animation
                try {
                    playerModel.setAttribute('animation-mixer', {
                        clip: animName,
                        loop: isOneShot ? 'once' : 'repeat',
                        crossFadeDuration: 0.2,
                        timeScale: 1.0
                    });
                    
                    console.log('Playing animation:', animName);
                } catch (e) {
                    console.warn('Could not play animation:', animName);
                }
                
                // If one-shot animation, return to appropriate animation after duration
                if (isOneShot) {
                    const duration = ANIMATION_DURATIONS[animName] || 500;
                    
                    animationTimeout = setTimeout(() => {
                        if (isJumping && animName === ANIMATIONS.JUMP) {
                            // Jump will handle its own completion
                            return;
                        }
                        
                        if (joystickActive) {
                            // Return to movement animation
                            updateMovementAnimation();
                        } else {
                            // Return to idle
                            setAnimation(ANIMATIONS.IDLE);
                        }
                        animationTimeout = null;
                    }, duration);
                }
            }
            
            function updateMovementAnimation() {
                if (isJumping || !joystickActive) return;
                
                const magnitude = Math.sqrt(joystickX * joystickX + joystickY * joystickY);
                
                if (magnitude < 0.1) {
                    setAnimation(ANIMATIONS.IDLE);
                    return;
                }
                
                const isRunning = magnitude > 0.7;
                
                // Determine direction based on joystick input
                if (Math.abs(joystickX) > Math.abs(joystickY)) {
                    // Strafe left/right
                    if (joystickX > 0) {
                        setAnimation(isRunning ? ANIMATIONS.RUN_RIGHT : ANIMATIONS.WALK_RIGHT);
                    } else {
                        setAnimation(isRunning ? ANIMATIONS.RUN_LEFT : ANIMATIONS.WALK_LEFT);
                    }
                } else {
                    // Forward/backward
                    if (joystickY > 0) {
                        setAnimation(isRunning ? ANIMATIONS.RUN_FORWARD : ANIMATIONS.WALK_FORWARD);
                    } else {
                        setAnimation(isRunning ? ANIMATIONS.RUN_BACKWARDS : ANIMATIONS.WALK_BACKWARDS);
                    }
                }
            }
            
            // ===== Jump Function =====
            function jump() {
                if (isJumping) return;
                
                isJumping = true;
                setAnimation(ANIMATIONS.JUMP, true);
                
                const startY = player.getAttribute('position').y;
                const jumpStart = Date.now();
                const JUMP_DURATION = 500;
                const JUMP_HEIGHT = 0.08;
                
                function animateJump() {
                    const elapsed = Date.now() - jumpStart;
                    const progress = Math.min(elapsed / JUMP_DURATION, 1);
                    
                    if (progress >= 1) {
                        const pos = player.getAttribute('position');
                        pos.y = 0.06;
                        player.setAttribute('position', pos);
                        isJumping = false;
                        
                        // Return to appropriate animation
                        if (joystickActive) {
                            updateMovementAnimation();
                        } else {
                            setAnimation(ANIMATIONS.IDLE);
                        }
                        return;
                    }
                    
                    // Parabolic arc
                    const jumpProgress = Math.sin(progress * Math.PI);
                    const pos = player.getAttribute('position');
                    pos.y = startY + (JUMP_HEIGHT * jumpProgress);
                    player.setAttribute('position', pos);
                    
                    requestAnimationFrame(animateJump);
                }
                
                animateJump();
            }
            
            // ===== Shoot Function =====
            function shoot() {
                if (isJumping) return;
                setAnimation(ANIMATIONS.SHOOT_RIFLE, true);
                
                // Muzzle flash
                if (gunModel) {
                    gunModel.setAttribute('material', 'emissive', '#FF5500');
                    gunModel.setAttribute('material', 'emissiveIntensity', '2.0');
                    
                    setTimeout(() => {
                        gunModel.setAttribute('material', 'emissive', '#000000');
                        gunModel.setAttribute('material', 'emissiveIntensity', '0');
                    }, 100);
                }
            }
            
            // ===== Throw Grenade =====
            function throwGrenade() {
                if (isJumping) return;
                setAnimation(ANIMATIONS.THROW_GRENADE, true);
            }
            
            // ===== Joystick Setup =====
            const moveJoystick = document.getElementById('move-joystick');
            const joystickHandle = document.getElementById('joystick-handle');
            
            moveJoystick.addEventListener('touchstart', (e) => {
                e.preventDefault();
                joystickActive = true;
                updateJoystick(e.touches[0]);
            });
            
            moveJoystick.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (joystickActive) updateJoystick(e.touches[0]);
            });
            
            moveJoystick.addEventListener('touchend', (e) => {
                e.preventDefault();
                joystickActive = false;
                joystickX = 0;
                joystickY = 0;
                joystickHandle.style.transform = 'translate(0px, 0px)';
                
                if (!isJumping) {
                    setAnimation(ANIMATIONS.IDLE);
                }
            });
            
            function updateJoystick(touch) {
                const rect = moveJoystick.getBoundingClientRect();
                const centerX = rect.left + rect.width/2;
                const centerY = rect.top + rect.height/2;
                
                let deltaX = touch.clientX - centerX;
                let deltaY = touch.clientY - centerY;
                
                const maxDistance = 40;
                const distance = Math.sqrt(deltaX*deltaX + deltaY*deltaY);
                
                if (distance > maxDistance) {
                    deltaX = (deltaX/distance) * maxDistance;
                    deltaY = (deltaY/distance) * maxDistance;
                }
                
                joystickHandle.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
                joystickX = deltaX / maxDistance;
                joystickY = deltaY / maxDistance;
                
                if (!isJumping) {
                    updateMovementAnimation();
                }
            }
            
            // ===== Button Setup =====
            document.getElementById('jump-btn').addEventListener('touchstart', (e) => {
                e.preventDefault();
                jump();
            });
            
            document.getElementById('shoot-btn').addEventListener('touchstart', (e) => {
                e.preventDefault();
                shoot();
            });
            
            document.getElementById('grenade-btn').addEventListener('touchstart', (e) => {
                e.preventDefault();
                throwGrenade();
            });
            
            // Keyboard fallback
            window.addEventListener('keydown', (e) => {
                switch(e.key) {
                    case ' ': e.preventDefault(); jump(); break;
                    case 'f': e.preventDefault(); shoot(); break;
                    case 'g': e.preventDefault(); throwGrenade(); break;
                }
            });
            
            // ===== Movement =====
            function movePlayer() {
                if (!joystickActive || isJumping || !player || !camera) return;
                
                const playerPos = player.getAttribute('position');
                const cameraRot = camera.getAttribute('rotation');
                
                const radY = THREE.MathUtils.degToRad(cameraRot.y);
                const magnitude = Math.sqrt(joystickX * joystickX + joystickY * joystickY);
                const speed = magnitude > 0.7 ? RUN_SPEED : WALK_SPEED;
                
                // Forward/back
                if (joystickY !== 0) {
                    playerPos.x += Math.sin(radY) * joystickY * speed * -1;
                    playerPos.z += Math.cos(radY) * joystickY * speed * -1;
                }
                
                // Strafe
                if (joystickX !== 0) {
                    playerPos.x += Math.sin(radY + Math.PI/2) * joystickX * speed;
                    playerPos.z += Math.cos(radY + Math.PI/2) * joystickX * speed;
                }
                
                // Keep in bounds
                playerPos.x = Math.max(-45, Math.min(45, playerPos.x));
                playerPos.z = Math.max(-45, Math.min(45, playerPos.z));
                
                player.setAttribute('position', playerPos);
            }
            
            // ===== Camera Follow =====
            function updateCamera() {
                if (!player || !camera) return;
                
                const playerPos = player.getAttribute('position');
                
                camera.setAttribute('position', {
                    x: playerPos.x,
                    y: playerPos.y + 0.3,
                    z: playerPos.z + 0.6
                });
                
                // Update HUD
                if (posX) posX.textContent = Math.round(playerPos.x * 10) / 10;
                if (posZ) posZ.textContent = Math.round(playerPos.z * 10) / 10;
            }
            
            // ===== Model Loading =====
            let modelsLoaded = 0;
            
            if (playerModel) {
                playerModel.addEventListener('model-loaded', () => {
                    console.log('‚úÖ Player model loaded');
                    modelsLoaded++;
                    loadingStatus.textContent = '‚úì Player loaded, loading gun...';
                    
                    // Get available animations
                    setTimeout(() => {
                        try {
                            const mixer = playerModel.components['animation-mixer'];
                            if (mixer && mixer.clips) {
                                availableAnimations = mixer.clips.map(clip => clip.name);
                                debugAnim.innerHTML = 'üé¨ Available animations:<br>' + 
                                    availableAnimations.map(a => '‚Ä¢ ' + a).join('<br>');
                                console.log('Available animations:', availableAnimations);
                            }
                        } catch(e) {
                            console.warn('Could not get animation list');
                        }
                    }, 1000);
                    
                    checkAllLoaded();
                });
                
                playerModel.addEventListener('error', (e) => {
                    console.error('Player model error:', e);
                    loadingStatus.textContent = '‚ö†Ô∏è Using fallback';
                    modelsLoaded++;
                    checkAllLoaded();
                });
            }
            
            if (gunModel) {
                gunModel.addEventListener('model-loaded', () => {
                    console.log('‚úÖ Gun model loaded');
                    modelsLoaded++;
                    loadingStatus.textContent = '‚úì Gun loaded';
                    
                    // Make gun visible
                    gunModel.setAttribute('visible', 'true');
                    checkAllLoaded();
                });
                
                gunModel.addEventListener('error', (e) => {
                    console.error('Gun model error:', e);
                    loadingStatus.textContent = '‚ö†Ô∏è Using simple gun';
                    
                    // Create simple gun
                    const simpleGun = document.createElement('a-box');
                    simpleGun.setAttribute('width', '0.2');
                    simpleGun.setAttribute('height', '0.1');
                    simpleGun.setAttribute('depth', '0.4');
                    simpleGun.setAttribute('color', '#333');
                    simpleGun.setAttribute('position', '0 0 0');
                    gun.appendChild(simpleGun);
                    
                    modelsLoaded++;
                    checkAllLoaded();
                });
            }
            
            function checkAllLoaded() {
                if (modelsLoaded >= 2) {
                    loadingStatus.textContent = '‚ú® World ready!';
                    
                    // Try to attach gun to hand bone
                    setTimeout(() => {
                        try {
                            const model = playerModel.getObject3D('mesh');
                            if (model) {
                                model.traverse((node) => {
                                    if (node.isBone && node.name.toLowerCase().includes('hand')) {
                                        console.log('Found hand bone:', node.name);
                                        const gunObj = gun.object3D;
                                        const parent = gunObj.parent;
                                        if (parent) parent.remove(gunObj);
                                        node.add(gunObj);
                                        gunObj.position.set(0.01, 0.01, 0.005);
                                        gunObj.rotation.set(0, Math.PI/2, 0);
                                    }
                                });
                            }
                        } catch(e) {
                            console.log('Could not attach to bone');
                        }
                    }, 1000);
                    
                    setTimeout(() => {
                        loadingScreen.style.opacity = '0';
                        setTimeout(() => {
                            loadingScreen.style.display = 'none';
                        }, 500);
                    }, 1000);
                    
                    // Start idle animation
                    setAnimation(ANIMATIONS.IDLE);
                }
            }
            
            // ===== Game Loop =====
            function gameLoop() {
                movePlayer();
                updateCamera();
                requestAnimationFrame(gameLoop);
            }
            
            // Start
            scene.addEventListener('loaded', () => {
                console.log('Scene loaded');
                gameLoop();
            });
            
            // Fallback start
            setTimeout(() => {
                if (!loadingScreen.style.display) {
                    gameLoop();
                }
            }, 3000);
        })();
    </script>
</body>
    </html>
